<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data_Bleed</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&family=Inter:wght@400;700&display=swap"
    rel="stylesheet">
  
  <!-- Responsive Design System -->
  <link rel="stylesheet" href="./css/responsive-design.css">

  <style>
    /* --- Base Styles --- */
    body {
      margin: 0;
      background: #000;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      color: white;
    }

    .hidden {
      display: none;
    }

    /* --- Intro Screen --- */
    #intro-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: black;
      z-index: 9999;
    }

    iframe#start-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* --- Animation Container --- */
    #intro-video {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: black;
      z-index: 9998;
    }

    #intro-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    /* --- Login Screen --- */
    #login-screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .glitch-title {
      color: white;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 2.5rem;
      text-align: center;
    }

    /* --- Character Login Container --- */
    .character-login {
      position: relative;
      width: 90%;
      max-width: 800px;
      height: 80vh;
      overflow-y: auto;
      border-radius: 12px;
    }

    iframe.login-frame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* --- Character Selector --- */
    #character-selector {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .character-card {
      width: 180px;
      padding: 15px;
      background: #111;
      border: 2px solid #555;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }

    .character-card:hover {
      transform: scale(1.1);
      border-color: #00FFFF;
    }

    .character-card.active {
      border-color: #00FFFF;
      box-shadow: 0 0 15px #00FFFF;
    }

    .character-card h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .character-card p {
      font-size: 0.85rem;
      color: #aaa;
    }

    /* --- Chat, Video & Fireworks --- */
    #fireworks {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
    }

    #video-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      cursor: pointer;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.5);
      transition: transform 0.3s ease;
      z-index: 10;
      display: none;
    }

    #video-container:hover {
      transform: scale(1.15);
    }

    #chroma-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #chat-box {
      position: fixed;
      bottom: 120px;
      right: 20px;
      width: 280px;
      height: 380px;
      background: rgba(20, 20, 20, 0.92);
      border: 2px solid #00FFFF;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      padding: 10px;
      z-index: 20;
    }

    #chat-box header {
      font-weight: bold;
      margin-bottom: 10px;
      text-align: center;
      position: relative;
    }

    #chat-box .close-btn {
      position: absolute;
      right: 0;
      top: 0;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    #chat-box .messages {
      flex: 1;
      overflow-y: auto;
      font-size: 14px;
    }

    #chat-box form {
      display: flex;
      margin-top: 8px;
    }

    #chat-box input {
      flex: 1;
      padding: 6px;
      border: 1px solid #7928CA;
      background: #333;
      color: white;
      border-radius: 6px;
    }

    #chat-box button[type="submit"] {
      margin-left: 6px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: #FF0080;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }

    .typing-indicator {
      font-style: italic;
      color: #888;
    }

    /* --- Character Dashboards --- */
    .character-ui {
      margin: 20px;
      padding: 20px;
      border: 2px solid #00FFFF;
      border-radius: 12px;
      background: rgba(20, 20, 20, 0.85);
    }

    /* --- Gameplay States --- */
    #gameplay-area {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
    }

    .fade-out {
      animation: fadeOutAnimation 0.6s forwards;
    }

    .fade-in {
      animation: fadeInAnimation 0.6s forwards;
      opacity: 0;
      visibility: visible;
    }

    @keyframes fadeOutAnimation {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
        visibility: hidden;
      }
    }

    @keyframes fadeInAnimation {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <canvas id="fireworks"></canvas>

  <!-- Intro Start Screen -->
  <div id="intro-screen">
    <iframe id="start-frame" src="./Start_Here_Screen/Start_Button.html"></iframe>
  </div>

  <!-- Intro Animation -->
  <div id="intro-video">
    <video id="logo-animation" playsinline>
      <source src="./Main_Animations/DataBleed_Logo_Animation_Adobe_Take_10.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- Login Screen - REMOVED: Now using Enhanced_Login_System exclusively -->
  <div id="login-screen" style="display: none;">
    <!-- Old login system completely removed to prevent flashing -->
  </div>

  <!-- Background Audio -->
  <!-- Start audio removed - handled by Start_Button.html to prevent duplicate playback -->
  <audio id="eli-audio" src="./Main_Login_Audio/Eli_Rage_Glitch.mp3" loop></audio>
  <audio id="maya-audio" src="./Main_Login_Audio/Maya_The_Connection_Trap.mp3" loop></audio>
  <audio id="stanley-audio" src="./Main_Login_Audio/Stanely_The Digital Doppelganger.mp3" loop></audio>

  <!-- Gameplay Area - Two State System -->
  <div id="gameplay-area" class="hidden">

    <!-- Dashboard View - Detailed character dashboard -->
    <div id="dashboard-view">

      <!-- Maya's Full Dashboard -->
      <div id="maya-dashboard" class="hidden">
        <iframe src="./Main_Dashboards/Maya_Dashboard_V2.html"
          style="width: 100%; height: 100vh; border: none;"></iframe>
        <!-- Enter Gameplay Areas Button -->
        <button id="maya-enter-gameplay" onclick="enterGameplayAreas('maya')"
          style="position: fixed; top: 70px; left: 20px; z-index: 1001; padding: 12px 25px; background: linear-gradient(135deg, #ff1493 0%, #00bfff 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-family: inherit; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);">
          üéÆ Enter Maya's Areas
        </button>
      </div>

      <!-- Eli's Full Dashboard -->
      <div id="eli-dashboard" class="hidden">
        <iframe src="./Main_Dashboards/Eli_Dashboard_V2.html"
          style="width: 100%; height: 100vh; border: none;"></iframe>
        <!-- Enter Gameplay Areas Button -->
        <button id="eli-enter-gameplay" onclick="enterGameplayAreas('eli')"
          style="position: fixed; top: 70px; left: 20px; z-index: 1001; padding: 12px 25px; background: linear-gradient(135deg, #00ffff 0%, #0066ff 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-family: inherit; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);">
          üéÆ Enter Eli's Areas
        </button>
      </div>

      <!-- Stanley's Full Dashboard -->
      <div id="stanley-dashboard" class="hidden">
        <iframe src="./Main_Dashboards/Stanley_Dashboard_V1.html"
          style="width: 100%; height: 100vh; border: none;"></iframe>
        <!-- Enter Gameplay Areas Button -->
        <button id="stanley-enter-gameplay" onclick="enterGameplayAreas('stanley')"
          style="position: fixed; top: 70px; left: 20px; z-index: 1001; padding: 12px 25px; background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; font-family: inherit; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(156, 163, 175, 0.4);">
          üéÆ Enter Stanley's Areas
        </button>
      </div>
    </div>

    <!-- Game View - Minimal HUD + Chroma Orb -->
    <div id="game-view" class="hidden">
      <button id="pause-game-btn"
        style="position: fixed; top: 20px; left: 20px; z-index: 1000; padding: 10px 20px; background: #00FFFF; color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">‚è∏
        Pause Game</button>

      <!-- Minimal Character HUDs -->
      <div id="eli-hud" class="character-ui hidden" style="position: fixed; top: 20px; left: 200px; width: 250px;">
        <h3>Eli's HUD</h3>
        <p>üéÆ Rank: Diamond<br>üî• Peer Pressure: 67%</p>
      </div>
      <div id="maya-hud" class="character-ui hidden" style="position: fixed; top: 20px; left: 200px; width: 250px;">
        <h3>Maya's HUD</h3>
        <p>üîê Suspicious DMs: 3<br>üíî Blocked Profiles: 12</p>
      </div>
      <div id="stanley-hud" class="character-ui hidden" style="position: fixed; top: 20px; left: 200px; width: 250px;">
        <h3>Stanley's HUD</h3>
        <p>üïµÔ∏è Doppelganger Alerts: 2<br>üìÇ Fake Profiles: 5</p>
      </div>

      <!-- Chroma Bot Orb + Chat -->
      <div id="video-container"><video id="chroma-video" autoplay loop muted playsinline>
          <source src="/chroma-bot/assets/vid/Chroma_Vid.mp4">
        </video></div>
      <div id="chat-box">
        <header>üí¨ Chroma Bot <button id="close-chat" class="close-btn">‚úñ</button></header>
        <div class="messages" id="messages">
          <p><b>Bot:</b> Hi! Click the logo anytime to chat üéÜ</p>
        </div>
        <form id="chat-form"><input type="text" id="userInput" placeholder="Type a message..." required><button
            type="submit">Send</button></form>
      </div>
    </div>
  </div>

  <!-- Character Dashboards -->
  <div id="eli-ui" class="character-ui hidden">
    <h3>Eli‚Äôs Dashboard</h3>
    <p>üéÆ Rank: Diamond<br>üî• Peer Pressure Meter: 67%</p>
  </div>
  <div id="maya-ui" class="character-ui hidden">
    <h3>Maya‚Äôs Dashboard</h3>
    <p>üîê Suspicious DMs: 3<br>üíî Blocked Profiles: 12</p>
  </div>
  <div id="stanley-ui" class="character-ui hidden">
    <h3>Stanley‚Äôs Dashboard</h3>
    <p>üïµÔ∏è Doppelganger Alerts: 2<br>üìÇ Fake Profiles Logged: 5</p>
  </div>

  <!-- API Configuration Module -->
  <script src="./js/api-config.js"></script>
  
  <!-- Error Handling System -->
  <script src="./js/error-handler.js"></script>
  
  <!-- Performance Tracking System -->
  <script src="./js/performance-tracker.js"></script>
  
  <!-- Deployment Monitoring System -->
  <script src="./js/deployment-monitor.js"></script>
  
  <script>
    // --- API BASE ---
    // Use the centralized API configuration system
    let API_BASE = window.APIConfig.getApiBaseUrl();

    // --- DOM REFERENCES ---
    const loginScreen = document.getElementById("login-screen");
    const gameplayArea = document.getElementById("gameplay-area");
    const dashboardView = document.getElementById("dashboard-view");
    const gameView = document.getElementById("game-view");
    const pauseBtn = document.getElementById("pause-game-btn");

    const videoContainer = document.getElementById("video-container");
    const video = document.getElementById("chroma-video");
    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const userInput = document.getElementById("userInput");
    const messages = document.getElementById("messages");
    const closeChat = document.getElementById("close-chat");
    const canvas = document.getElementById("fireworks");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;

    const eliLogin = document.getElementById("eli-login");
    const mayaLogin = document.getElementById("maya-login");
    const stanleyLogin = document.getElementById("stanley-login");

    // Dashboard elements
    const mayaDashboard = document.getElementById("maya-dashboard");
    const eliDashboard = document.getElementById("eli-dashboard");
    const stanleyDashboard = document.getElementById("stanley-dashboard");

    // HUD elements
    const mayaHUD = document.getElementById("maya-hud");
    const eliHUD = document.getElementById("eli-hud");
    const stanleyHUD = document.getElementById("stanley-hud");

    // Legacy UI elements (for backward compatibility)
    const eliUI = document.getElementById("eli-ui");
    const mayaUI = document.getElementById("maya-ui");
    const stanleyUI = document.getElementById("stanley-ui");

    // --- AUDIO ---
    // Start audio removed - handled by Start_Button.html iframe
    const eliAudio = document.getElementById("eli-audio");
    const mayaAudio = document.getElementById("maya-audio");
    const stanleyAudio = document.getElementById("stanley-audio");

    // --- INTRO ---
    const introScreen = document.getElementById("intro-screen");
    const introVideo = document.getElementById("intro-video");
    const logoAnimation = document.getElementById("logo-animation");

    const startFrame = document.getElementById("start-frame");
    window.addEventListener("message", (event) => {
      if (event.data === "start-clicked") {
        console.log("üé¨ Start button clicked - beginning intro sequence");
        
        // Music is already stopped by Start_Button.html before sending this message
        console.log("üîá Initialize button music stopped by iframe");
        
        // Hide intro screen
        introScreen.style.display = "none"; 
        
        // Show and play logo animation
        introVideo.style.display = "block";
        console.log("üì∫ Showing intro video container");
        
        // Play video WITH audio (not muted) - video has embedded "Data Bleed" audio
        logoAnimation.muted = false; // Allow video audio to play
        logoAnimation.volume = 1.0; // Full volume for video audio
        logoAnimation.play()
          .then(() => {
            console.log("‚ñ∂Ô∏è Logo animation playing with embedded audio");
          })
          .catch(err => {
            console.error("‚ùå Logo animation play failed:", err);
            // If video fails, skip to character selector after a delay
            setTimeout(() => {
              console.log("‚è≠Ô∏è Skipping to character selector due to video error");
              window.location.href = './Enhanced_Login_System/enhanced-character-selector.html';
            }, 2000);
          });
        
        // Listen for video end
        logoAnimation.addEventListener("ended", () => {
          console.log("‚úÖ Logo animation completed");
          
          // Navigate directly to character selector (no QR code here)
          introVideo.style.display = "none";
          console.log("üéØ Navigating to character selector");
          window.location.href = './Enhanced_Login_System/enhanced-character-selector.html';
        }, { once: true }); // Use once: true to prevent multiple listeners
      }
    });

    // --- CHARACTER SWITCH ---
    document.querySelectorAll(".character-card").forEach(card => {
      card.addEventListener("click", () => {
        const choice = card.dataset.character;
        // Hide all login forms
        [eliLogin, mayaLogin, stanleyLogin].forEach(el => el.style.display = "none");
        document.querySelectorAll(".character-card").forEach(c => c.classList.remove("active"));

        // Show selected character's login form and activate card
        card.classList.add("active");
        if (choice === "eli") {
          eliLogin.style.display = "block";
          switchTheme("eli");
        }
        if (choice === "maya") {
          mayaLogin.style.display = "block";
          switchTheme("maya");
        }
        if (choice === "stanley") {
          stanleyLogin.style.display = "block";
          switchTheme("stanley");
        }
      });
    });

    // --- THEME SWITCHER ---
    function switchTheme(character) {
      [eliAudio, mayaAudio, stanleyAudio].forEach(a => { a.pause(); a.currentTime = 0; });
      if (character === "eli") eliAudio.play().catch(() => { });
      if (character === "maya") mayaAudio.play().catch(() => { });
      if (character === "stanley") stanleyAudio.play().catch(() => { });
    }

    // --- IFRAME CONNECTION ---
    window.addEventListener("message", (event) => {
      if (event.data.action === "eli-connected") handleExternalConnect("eli", event.data.gamertag);
      if (event.data.action === "maya-connected") handleExternalConnect("maya", event.data.gamertag);
      if (event.data.action === "stanley-connected") handleExternalConnect("stanley", event.data.gamertag);
      if (event.data.action === "pause-game") {
        console.log(`‚è∏Ô∏è Received pause-game message for ${event.data.character}`);
        // Clear gameplay session data
        sessionStorage.removeItem('gameplayCharacter');
        sessionStorage.removeItem('gameplayArea');
        sessionStorage.removeItem('gameplayMode');
        // Show the character's dashboard
        showDashboardView(event.data.character);
      }
    });

    function handleExternalConnect(characterKey, gamertag) {
      // 1. Validate input parameters
      if (!characterKey || !gamertag) {
        console.error("‚ùå Invalid login data:", { characterKey, gamertag });
        return;
      }

      // Validate character is supported
      const validCharacters = ["maya", "eli", "stanley"];
      if (!validCharacters.includes(characterKey.toLowerCase())) {
        console.error("‚ùå Unsupported character:", characterKey);
        return;
      }

      // 2. Store session data immediately upon login success
      try {
        sessionStorage.setItem("character", characterKey.toLowerCase());
        sessionStorage.setItem("gamertag", gamertag.trim());
        sessionStorage.setItem("loginTimestamp", Date.now().toString());
        sessionStorage.setItem("currentState", "gameplay");
        
        console.log("‚úÖ Session data stored:", {
          character: characterKey.toLowerCase(),
          gamertag: gamertag.trim(),
          timestamp: new Date().toISOString()
        });
      } catch (error) {
        console.error("‚ùå Failed to store session data:", error);
        return;
      }

      // 3. Validate session data before proceeding with state transition
      const storedCharacter = sessionStorage.getItem("character");
      const storedGamertag = sessionStorage.getItem("gamertag");
      
      if (!storedCharacter || !storedGamertag) {
        console.error("‚ùå Session validation failed after storage");
        return;
      }

      // 4. Orchestrate login state fade-out
      console.log("üé¨ Starting login fade-out animation");
      
      // Add fade-out class to loginScreen element
      loginScreen.classList.add("fade-out");
      
      // Also fade out intro elements if still visible
      if (introScreen.style.display !== "none") {
        introScreen.classList.add("fade-out");
      }
      if (introVideo.style.display !== "none") {
        introVideo.classList.add("fade-out");
      }

      // Set timeout to match CSS animation duration (600ms)
      setTimeout(() => {
        console.log("üé¨ Login fade-out complete, transitioning to gameplay");
        
        // Completely hide login screen after fade completes
        loginScreen.style.display = "none";
        loginScreen.classList.remove("fade-out"); // Clean up class
        
        // Hide intro elements completely
        introScreen.style.display = "none";
        introScreen.classList.remove("fade-out");
        introVideo.style.display = "none";
        introVideo.classList.remove("fade-out");

        // 5. Orchestrate gameplay state fade-in
        console.log("üé¨ Starting gameplay fade-in animation");
        
        // Remove hidden class from gameplayArea
        gameplayArea.classList.remove("hidden");
        gameplayArea.style.display = "block";
        
        // Add fade-in class for smooth appearance
        gameplayArea.classList.add("fade-in");
        
        // Initialize gameplay components after transition
        setTimeout(() => {
          console.log("üé¨ Gameplay fade-in complete, initializing components");
          gameplayArea.classList.remove("fade-in"); // Clean up class
          initializeGameplayState(characterKey);
          showDashboardView(characterKey);
        }, 600); // Match CSS animation duration
      }, 600); // Match CSS animation duration
    }

    function showDashboardView(characterKey) {
      console.log(`üéÆ Showing dashboard view for: ${characterKey}`);
      
      // Hide game view, show dashboard view
      gameView.classList.add("hidden");
      dashboardView.classList.remove("hidden");

      // Hide all dashboards first
      [mayaDashboard, eliDashboard, stanleyDashboard].forEach(dash => dash.classList.add("hidden"));

      // Resume functionality now handled by "Enter Gameplay Areas" buttons

      // Show the correct character's dashboard
      if (characterKey === "maya") mayaDashboard.classList.remove("hidden");
      if (characterKey === "eli") eliDashboard.classList.remove("hidden");
      if (characterKey === "stanley") stanleyDashboard.classList.remove("hidden");
      
      console.log(`‚úÖ Dashboard view initialized for ${characterKey}`);
    }

    function initializeGameplayState(characterKey) {
      console.log(`üéÆ Initializing unified gameplay state for: ${characterKey}`);
      
      // UNIFIED: Initialize Chroma Bot Orb (same for all characters)
      const videoContainer = document.getElementById("video-container");
      const video = document.getElementById("chroma-video");
      
      if (videoContainer) {
        videoContainer.style.display = "block";
        videoContainer.style.position = "fixed";
        videoContainer.style.bottom = "20px";
        videoContainer.style.right = "20px";
        videoContainer.style.zIndex = "2000";
        console.log("‚úÖ Chroma orb container initialized with unified positioning");
      }
      
      if (video) {
        // Ensure video asset path is correct and plays
        video.src = "/chroma-bot/assets/vid/Chroma_Vid.mp4";
        video.loop = true;
        video.muted = true;
        video.autoplay = true;
        video.play().catch(err => console.warn("Video autoplay blocked:", err));
        console.log("‚úÖ Chroma orb video initialized with unified settings");
      }
      
      // UNIFIED: Initialize Chat System (same positioning for all characters)
      const chatBox = document.getElementById("chat-box");
      if (chatBox) {
        chatBox.style.display = "none";
        chatBox.style.position = "fixed";
        chatBox.style.bottom = "120px";
        chatBox.style.right = "20px";
        chatBox.style.zIndex = "2001";
        console.log("‚úÖ Chat system initialized with unified positioning");
      }
      
      // UNIFIED: Initialize Audio Theme (character-specific but same pattern)
      switchTheme(characterKey);
      console.log(`‚úÖ Audio theme switched to: ${characterKey}`);
      
      // UNIFIED: Ensure all UI elements are properly positioned
      ensureUnifiedUIPositioning();
      
      console.log(`üéÆ Unified gameplay state initialization complete for ${characterKey}`);
    }

    function ensureUnifiedUIPositioning() {
      // Ensure consistent positioning for all UI elements across characters
      const videoContainer = document.getElementById("video-container");
      const chatBox = document.getElementById("chat-box");
      
      if (videoContainer) {
        videoContainer.style.cssText = `
          position: fixed !important;
          bottom: 20px !important;
          right: 20px !important;
          width: 80px !important;
          height: 80px !important;
          z-index: 2000 !important;
          cursor: pointer !important;
          border-radius: 50% !important;
          overflow: hidden !important;
          box-shadow: 0 0 12px rgba(0, 255, 255, 0.5) !important;
        `;
      }
      
      if (chatBox) {
        chatBox.style.cssText = `
          position: fixed !important;
          bottom: 120px !important;
          right: 20px !important;
          width: 280px !important;
          height: 380px !important;
          z-index: 2001 !important;
          background: rgba(20, 20, 20, 0.92) !important;
          border: 2px solid #00FFFF !important;
          border-radius: 12px !important;
          padding: 10px !important;
          flex-direction: column !important;
        `;
      }
      
      console.log("‚úÖ Unified UI positioning enforced");
    }

    function showGameView(characterKey) {
      console.log(`üéÆ Transitioning to Game View for: ${characterKey}`);

      const dashboardView = document.getElementById("dashboard-view");
      const gameView = document.getElementById("game-view");
      const pauseBtn = document.getElementById("pause-game-btn");
      const videoContainer = document.getElementById("video-container");
      const video = document.getElementById("chroma-video");
      const chatBox = document.getElementById("chat-box");

      // 1. Hide the Dashboard View completely
      if (dashboardView) dashboardView.classList.add("hidden");

      // 2. Show the Game View container
      if (gameView) gameView.classList.remove("hidden");

      // 3. Show the correct minimalist HUD for the active character
      const mayaHUD = document.getElementById("maya-hud");
      const eliHUD = document.getElementById("eli-hud");
      const stanleyHUD = document.getElementById("stanley-hud");
      [mayaHUD, eliHUD, stanleyHUD].forEach(hud => {
        if (hud) hud.classList.add("hidden");
      });
      if (characterKey === "maya" && mayaHUD) mayaHUD.classList.remove("hidden");
      if (characterKey === "eli" && eliHUD) eliHUD.classList.remove("hidden");
      if (characterKey === "stanley" && stanleyHUD) stanleyHUD.classList.remove("hidden");

      // 4. UNIFIED: Show the Pause Button (consistent for all characters)
      if (pauseBtn) {
        pauseBtn.classList.remove("hidden");
        pauseBtn.style.display = "block";
        pauseBtn.style.position = "fixed";
        pauseBtn.style.top = "20px";
        pauseBtn.style.left = "20px";
        pauseBtn.style.zIndex = "1000";
      }

      // 5. UNIFIED: Show the Chroma Bot Orb (consistent positioning for all characters)
      if (videoContainer) {
        videoContainer.style.display = "block";
        videoContainer.style.position = "fixed";
        videoContainer.style.bottom = "20px";
        videoContainer.style.right = "20px";
        videoContainer.style.zIndex = "2000";
      }

      // 6. UNIFIED: Ensure the video inside the orb is playing (same for all characters)
      if (video) {
        video.play().catch(err => console.warn("Video autoplay blocked:", err));
        video.loop = true;
      }

      // 7. UNIFIED: Ensure chat is hidden initially (consistent for all characters)
      if (chatBox) {
        chatBox.style.display = "none";
        chatBox.style.position = "fixed";
        chatBox.style.bottom = "120px";
        chatBox.style.right = "20px";
        chatBox.style.zIndex = "2001";
      }

      console.log(`‚úÖ Game View transition complete for ${characterKey}. All UI elements positioned consistently.`);
    }

    // --- PAUSE GAME BUTTON ---

    if (pauseBtn) {
      pauseBtn.addEventListener("click", () => {
        const character = sessionStorage.getItem("character") || "maya";
        showDashboardView(character);
      });
    }

    // --- WINDOW REFRESH RESET ---
    window.addEventListener('beforeunload', () => {
      // Clear gameplay session data on refresh/close
      sessionStorage.removeItem('gameplayCharacter');
      sessionStorage.removeItem('gameplayArea');
      sessionStorage.removeItem('gameplayMode');
    });

    // Reset to login screen on page load if no valid session
    window.addEventListener('load', () => {
      const currentState = sessionStorage.getItem('currentState');
      const hash = window.location.hash;
      
      // Handle direct dashboard navigation from gameplay areas
      if (hash && hash.startsWith('#dashboard-')) {
        const character = hash.replace('#dashboard-', '');
        console.log(`üéØ Direct dashboard navigation for: ${character}`);
        
        // Set up session for dashboard view
        sessionStorage.setItem('character', character);
        sessionStorage.setItem('currentState', 'gameplay');
        
        // Show the character's dashboard
        setTimeout(() => {
          handleExternalConnect(character, sessionStorage.getItem('gamertag') || 'Player');
        }, 100);
        
        // Clear the hash
        window.location.hash = '';
        return;
      }
      
      if (!currentState) {
        // Reset to initial state
        loginScreen.style.display = 'flex';
        gameplayArea.classList.add('hidden');
        console.log('üîÑ Game reset to initial state');
      }
    });

    // --- TOGGLE CHAT ---
    videoContainer.addEventListener("click", (e) => { createFirework(e.clientX, e.clientY, "explode"); video.pause(); videoContainer.style.display = "none"; chatBox.style.display = "flex"; });
    closeChat.addEventListener("click", () => { const rect = videoContainer.getBoundingClientRect(); createFirework(rect.left + rect.width / 2, rect.top + rect.height / 2, "implode"); chatBox.style.display = "none"; videoContainer.style.display = "block"; video.play(); video.loop = true; });

    // --- CHAT ---
    function addMessage(sender, text) { const msg = document.createElement("p"); msg.innerHTML = `<b>${sender}:</b> ${text}`; messages.appendChild(msg); messages.scrollTop = messages.scrollHeight; }
    async function getBotResponse(userMessage) {
      const activeCharacter = sessionStorage.getItem("character") || "maya";
      const gamertag = sessionStorage.getItem("gamertag") || "Player";
      addMessage("Bot", `<span class="typing-indicator">...</span>`);
      
      try {
        // Use the centralized API configuration
        const apiUrl = window.APIConfig.getApiUrl('/api/chat');
        
        const response = await fetch(apiUrl, {
          method: "POST", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            message: userMessage, 
            character: activeCharacter, 
            sessionId: gamertag 
          })
        });
        
        if (!response.ok) {
          // Try to get error details from response
          let errorMessage = `Server responded with status ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage += `: ${errorData.error}`;
            }
          } catch (e) {
            // Ignore JSON parsing errors for error responses
          }
          throw new Error(errorMessage);
        }
        
        const data = await response.json(); 
        messages.removeChild(messages.lastChild); 
        addMessage("Bot", data.reply || "‚ö†Ô∏è No response received from AI.");
        
      } catch (err) { 
        console.error("Chat API error:", err); 
        messages.removeChild(messages.lastChild); 
        
        // Try to find a working API URL if the current one fails
        if (err.message.includes('Failed to fetch') || err.message.includes('NetworkError')) {
          console.log("üîÑ Network error detected, trying fallback URLs...");
          const workingUrl = await window.APIConfig.findWorkingApiUrl();
          if (workingUrl) {
            addMessage("Bot", "üîÑ Reconnected! Please try your message again.");
            API_BASE = workingUrl; // Update the global variable for compatibility
          } else {
            addMessage("Bot", "‚ùå Unable to connect to chat service. Please check your internet connection and try again later.");
          }
        } else {
          addMessage("Bot", `‚ö†Ô∏è Chat error: ${err.message}`);
        }
      }
    }
    if (chatForm) { chatForm.addEventListener("submit", async (e) => { e.preventDefault(); const text = userInput.value.trim(); if (!text) return; const gamertag = sessionStorage.getItem("gamertag") || "You"; addMessage(gamertag, text); userInput.value = ""; await getBotResponse(text); }); }

    // --- GAMEPLAY AREAS INTEGRATION ---
    function enterGameplayAreas(character) {
      console.log(`üéÆ Entering gameplay areas for: ${character}`);
      
      // Store character in session for gameplay areas
      sessionStorage.setItem('gameplayCharacter', character);
      sessionStorage.setItem('gameplayArea', '1');
      sessionStorage.setItem('gameplayMode', 'true');
      
      // For Eli, use the complete story system
      if (character === 'eli') {
        window.location.href = './videos/eli/eli-flexible-player.html';
        return;
      }
      
      // Navigate to first area for other characters
      const areaPath = `./gameplay-areas/${character}/area-1-${getAreaName(character, 1)}.html`;
      window.location.href = areaPath;
    }
    
    function getAreaName(character, areaNumber) {
      const areaNames = {
        maya: ['home-base', 'dating-app', 'investigation-hub', 'cyber-cafe', 'corporate-office', 'final-confrontation'],
        eli: ['gaming-setup', 'tournament-arena', 'gambling-platform', 'gaming-community', 'school-campus', 'championship-victory'],
        stanley: ['suburban-home', 'social-media-maze', 'financial-district', 'digital-marketplace', 'law-enforcement', 'protection-network']
      };
      
      return areaNames[character][areaNumber - 1];
    }

    // --- FIREWORKS ---
    class Firework { constructor(x, y, color, velocity) { this.x = x; this.y = y; this.color = color; this.velocity = velocity; this.alpha = 1; this.radius = 2; } draw() { ctx.save(); ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); ctx.restore(); } update() { this.x += this.velocity.x; this.y += this.velocity.y; this.alpha -= 0.02; this.draw(); } }
    let fireworks = []; function createFirework(x, y, mode = "explode") { const metallicColors = ["rgba(192,192,192,1)", "rgba(220,220,220,0.9)", "rgba(255,255,255,0.8)", "rgba(169,169,169,0.9)"]; const particleCount = mode === "explode" ? 100 : 70; const baseSpeed = mode === "explode" ? 5 : 4; for (let i = 0; i < particleCount; i++) { const angle = Math.random() * Math.PI * 2; const speed = Math.random() * baseSpeed + 1; const velocity = mode === "explode" ? { x: Math.cos(angle) * speed, y: Math.sin(angle) * speed } : { x: -Math.cos(angle) * speed * 0.5, y: -Math.sin(angle) * speed * 0.5 }; fireworks.push(new Firework(x, y, metallicColors[Math.floor(Math.random() * metallicColors.length)], velocity)); } }
    function animate() { requestAnimationFrame(animate); ctx.fillStyle = "rgba(0,0,0,0.15)"; ctx.fillRect(0, 0, canvas.width, canvas.height); fireworks = fireworks.filter((f) => { if (f.alpha <= 0) return false; f.update(); return true; }); }
    animate();
  </script>

  <!-- Three.js Library - Load from CDN for production compatibility -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  
  <!-- WebGL Fallback System -->
  <script src="./js/webgl-fallback.js"></script>
  
  <!-- 3D Scene Manager -->
  <script src="./js/three-scene-manager.js"></script>
  
  <!-- Mobile 3D Support (must load before 3d-integration) -->
  <script src="./js/mobile-3d-support.js"></script>
  
  <!-- Character 3D System (must load before 3d-integration) -->
  <script src="./js/character-3d-system.js"></script>
  
  <!-- 3D Integration Module -->
  <script src="./js/3d-integration.js"></script>
  
  <!-- Email Signup System -->
  <script src="./js/email-signup-system.js"></script>
  
  <!-- QR Logo System -->
  <script src="./js/qr-logo-system.js"></script>
</body>

</html>